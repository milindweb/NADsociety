<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>New Member Registration</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
    margin:0;
    font-family:Arial, Helvetica, sans-serif;
    background:#f3f4f6;
}
.container{
    padding:10px 15px;
}
.section{
    background:#ffffff;
    border:1px solid #ccc;
    padding:10px;
    margin-bottom:10px;
}
.section-title{
    font-size:15px;
    font-weight:bold;
    margin-bottom:6px;
}
.grid{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(220px,1fr));
    gap:8px;
}
.group{
    display:flex;
    flex-direction:column;
    font-size:13px;
}
input, select, textarea{
    padding:5px;
    font-size:13px;
}
textarea{ resize:none; height:50px; }
button{
    padding:6px 16px;
    font-size:13px;
    cursor:pointer;
}
.actions{
    text-align:center;
    margin-top:10px;
}
.readonly input,
.readonly textarea,
.readonly select{
    background:#eee;
    pointer-events:none;
}
.hidden{ display:none; }
</style>
</head>

<body>

<!-- ================= LOGIN CHECK ================= -->
<script>
if(sessionStorage.getItem("loggedIn") !== "true"){
    window.location.href = "login.html";
}
</script>

<!-- ================= HEADER ================= -->
<div id="header"></div>

<div class="container">

<!-- ================= FORM ================= -->
<div id="formBox">

    <!-- SYSTEM MEMBER ID (BACKEND GENERATED) -->
    <input type="hidden" id="member_id">

    <!-- ===== SECTION 1 ===== -->
    <div class="section">
        <div class="section-title">Member Identification & Service</div>

        <div class="grid">
            <div class="group">
                General Number *
                <input type="text" id="gen_no">
            </div>

            <div class="group">
                Token Number
                <input type="text" id="token_no">
            </div>

            <div class="group">
                Member Name *
                <input type="text" id="member_name">
            </div>

            <div class="group">
                Employee Type *
                <select id="emp_type">
                    <option value="">Select</option>
                    <option>Industrial</option>
                    <option>Non-Industrial</option>
                </select>
            </div>

            <div class="group">
                Department
                <select id="department">
                    <option value="">Select</option>
                    <option>Electrical</option>
                    <option>Electronics</option>
                    <option>Fitter</option>
                    <option>Admin</option>
                </select>
            </div>

            <div class="group">
                Date of Birth *
                <input type="date" id="dob">
            </div>

            <div class="group">
                Date of Retirement
                <input type="date" id="dor" readonly>
            </div>

            <div class="group">
                Date of Joining Society
                <input type="date" id="doj">
            </div>
        </div>
    </div>

    <!-- ===== SECTION 2 ===== -->
    <div class="section">
        <div class="section-title">Personal & KYC</div>

        <div class="grid">
            <div class="group">
                Aadhaar
                <input type="text" id="aadhaar" maxlength="12">
            </div>

            <div class="group">
                PAN
                <input type="text" id="pan" maxlength="10">
            </div>

            <div class="group">
                Mobile *
                <input type="text" id="mobile" maxlength="10">
            </div>

            <div class="group">
                Email
                <input type="email" id="email">
            </div>

            <div class="group">
                Present Address
                <textarea id="present_address"></textarea>
            </div>

            <div class="group">
                Permanent Address
                <textarea id="permanent_address"></textarea>
            </div>
        </div>
    </div>

    <!-- ===== SECTION 3 ===== -->
    <div class="section">
        <div class="section-title">Nominee</div>

        <div class="grid">
            <div class="group">
                Nominee Name
                <input type="text" id="nominee_name">
            </div>

            <div class="group">
                Nominee DOB
                <input type="date" id="nominee_dob">
            </div>

            <div class="group">
                Relationship
                <input type="text" id="nominee_relation">
            </div>
        </div>
    </div>

    <!-- ===== ACTIONS ===== -->
    <div class="section actions">
        <button onclick="saveDraft()">Save Draft</button>
        <button onclick="preview()">Preview</button>
    </div>

</div>

<!-- ================= PREVIEW ================= -->
<div id="previewBox" class="section readonly hidden">
    <div class="section-title">Preview (Read Only)</div>
    <div id="previewContent"></div>

    <div class="actions">
        <button onclick="editForm()">Edit</button>
        <button onclick="finalSave()">Final Save</button>
    </div>
</div>

</div>

<!-- ================= JS ================= -->
<script>
/* ---------- LOAD HEADER ---------- */
fetch("header.html")
.then(r=>r.text())
.then(h=>document.getElementById("header").innerHTML=h);

/* ---------- RETIREMENT AUTO ---------- */
dob.addEventListener("change",()=>{
    if(!dob.value) return;
    let d=new Date(dob.value);
    d.setFullYear(d.getFullYear()+60);
    dor.value=d.toISOString().split("T")[0];
});

/* ---------- DRAFT SAVE ---------- */
function saveDraft(){
    if(!gen_no.value.trim()) return;
    let data={};
    document.querySelectorAll("input,textarea,select").forEach(e=>{
        if(e.id) data[e.id]=e.value;
    });
    localStorage.setItem("member_draft_"+gen_no.value.trim(),JSON.stringify(data));
}

/* ---------- LOAD DRAFT ---------- */
gen_no.addEventListener("blur",()=>{
    let data=localStorage.getItem("member_draft_"+gen_no.value.trim());
    if(!data) return;
    data=JSON.parse(data);
    Object.keys(data).forEach(k=>{
        if(document.getElementById(k)) document.getElementById(k).value=data[k];
    });
});

/* ---------- PREVIEW ---------- */
function preview(){
    if(!gen_no.value || !member_name.value || !mobile.value){
        alert("Mandatory fields missing");
        return;
    }
    let html="";
    document.querySelectorAll("input,textarea,select").forEach(e=>{
        if(e.value && e.type!=="hidden"){
            html+=`<div><b>${e.previousSibling.textContent.trim()}:</b> ${e.value}</div>`;
        }
    });
    previewContent.innerHTML=html;
    formBox.classList.add("hidden");
    previewBox.classList.remove("hidden");
}

/* ---------- EDIT ---------- */
function editForm(){
    previewBox.classList.add("hidden");
    formBox.classList.remove("hidden");
}

/* ---------- FINAL SAVE ---------- */
function finalSave(){
    if(!/^\d{10}$/.test(mobile.value)){
        alert("Invalid Mobile Number"); return;
    }
    if(aadhaar.value && !/^\d{12}$/.test(aadhaar.value)){
        alert("Invalid Aadhaar"); return;
    }
    if(pan.value && !/^[A-Z]{5}[0-9]{4}[A-Z]$/.test(pan.value)){
        alert("Invalid PAN"); return;
    }

    alert("Member saved successfully.\nBackend will generate Member ID and redirect to profile.");
    localStorage.removeItem("member_draft_"+gen_no.value.trim());

    /*
    Python backend will:
    - generate member_id
    - save data
    - redirect to:
      member.html?member_id=XXXX
    */
}
</script>

</body>
</html>