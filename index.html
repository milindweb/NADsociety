<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Society Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
/* ================= BASE ================= */
body{
    margin:0;
    font-family:Arial, Helvetica, sans-serif;
    background:#f3f4f6;
}

/* ================= LAYOUT ================= */
.container{
    padding:12px 16px;
}

.section{
    background:#ffffff;
    border:1px solid #ccc;
    padding:10px;
    margin-bottom:10px;
}

.section-title{
    font-size:15px;
    font-weight:bold;
    margin-bottom:6px;
}

/* ================= GRID ================= */
.grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
    gap:8px;
}

/* ================= INPUT ================= */
input{
    width:100%;
    padding:6px;
    font-size:13px;
}

/* ================= VALUES ================= */
.value{
    font-weight:bold;
    min-height:16px;
}

/* ================= SEARCH RESULT ================= */
#searchResults{
    border:1px solid #ccc;
    border-top:none;
    max-height:220px;
    overflow-y:auto;
}

.search-row{
    padding:6px;
    font-size:13px;
    cursor:pointer;
    border-bottom:1px solid #e0e0e0;
}

.search-row:hover{
    background:#e9eef5;
}

/* ================= UTILITY ================= */
.hidden{ display:none; }
</style>
</head>

<body>

<!-- =====================================================
     LOGIN CHECK (STRICT – BEFORE ANY PAGE EXECUTION)
===================================================== -->
<script>
(function(){
    if(sessionStorage.getItem("loggedIn") !== "true"){
        window.location.replace("login.html");
    }
})();
</script>

<!-- ================= HEADER ================= -->
<div id="header"></div>

<!-- ================= PAGE CONTENT ================= -->
<div class="container">

    <!-- ================= MEMBER SEARCH ================= -->
    <div class="section">
        <div class="section-title">Member Search</div>

        <input
            type="text"
            id="memberSearch"
            placeholder="Search by General No / Token No / Name"
            autocomplete="off"
        >

        <!-- Autosuggest list (backend filled) -->
        <div id="searchResults"></div>
    </div>

    <!-- ================= DASHBOARD ================= -->
    <div class="section">
        <div class="section-title">Dashboard</div>

        <div class="grid">

            <div>
                Total Active Members
                <div class="value" id="totalActiveMembers"></div>
            </div>

            <div>
                Next Month Retirement
                <div class="value" id="nextMonthRetire"></div>
            </div>

            <div>
                Total CD
                <div class="value" id="totalCD"></div>
            </div>

            <div>
                Total Shares
                <div class="value" id="totalShares"></div>
            </div>

            <div>
                Active Short Loans
                <div class="value" id="activeShortLoan"></div>
            </div>

            <div>
                Active Long Loans
                <div class="value" id="activeLongLoan"></div>
            </div>

            <div>
                Total Loans Given
                <div class="value" id="totalLoansGiven"></div>
            </div>

            <div>
                Total FD (Count / Amount)
                <div class="value" id="totalFD"></div>
            </div>

        </div>
    </div>

</div>

<!-- =====================================================
     JAVASCRIPT (ROBUST, SAFE, BACKEND-READY)
===================================================== -->
<script>
/* ================= HEADER LOAD ================= */
fetch("header.html")
.then(res => {
    if(!res.ok) throw new Error("Header load failed");
    return res.text();
})
.then(html => {
    document.getElementById("header").innerHTML = html;
})
.catch(() => {
    document.getElementById("header").innerHTML =
        "<div style='padding:8px;background:#b91c1c;color:#fff'>Header Load Error</div>";
});

/* ================= MEMBER SEARCH ================= */
const searchInput = document.getElementById("memberSearch");
const resultsBox  = document.getElementById("searchResults");

searchInput.addEventListener("keyup", function(){
    const query = this.value.trim().toLowerCase();
    resultsBox.innerHTML = "";

    if(query.length < 2) return;

    /*
    BACKEND CONTRACT (IMPORTANT):
    GET /api/search?q=<query>

    Response JSON:
    [
      {
        member_id: <SYSTEM_ID>,
        gen_no: "...",
        token_no: "...",
        name: "..."
      }
    ]
    */

    fetch("/api/search?q=" + encodeURIComponent(query))
        .then(res => {
            if(!res.ok) throw new Error("Search failed");
            return res.json();
        })
        .then(list => {
            list.forEach(m => {
                const row = document.createElement("div");
                row.className = "search-row";
                row.textContent = m.gen_no + " - " + m.name;

                row.onclick = function(){
                    openMemberProfile(m.member_id);
                };

                resultsBox.appendChild(row);
            });
        })
        .catch(() => {
            /* silent fail – no UI noise */
        });
});

/* ================= OPEN MEMBER PROFILE ================= */
function openMemberProfile(memberId){
    if(!memberId) return;

    /*
    SYSTEM-ONLY STORAGE
    User never sees member_id
    */
    sessionStorage.setItem("active_member_id", memberId);

    window.location.href = "member.html";
}

/*
BACKEND RESPONSIBILITY (Python):
• Validate session
• Populate dashboard counters
• Provide search results
• Log audit events:
  - SEARCH
  - VIEW_MEMBER
*/
</script>

</body>
</html>